/**
 * Data Manager - –ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏, —Ç–∞–∫ –∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ
 */

export class DataManager {
    constructor() {
        this.users = [];
        this.games = [];
        this.news = [];
        this.supportTickets = [];
        this.loadData();
    }

    loadData() {
        this.users = this.safeGetItem('users', []);
        this.games = this.safeGetItem('games', []);
        this.news = this.safeGetItem('news', []);
        this.supportTickets = this.safeGetItem('supportTickets', []);
    }

    saveData() {
        this.safeSetItem('users', this.users);
        this.safeSetItem('games', this.games);
        this.safeSetItem('news', this.news);
        this.safeSetItem('supportTickets', this.supportTickets);
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        this.notifyDataChange();
    }

    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å localStorage
    safeGetItem(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (error) {
            console.error('Error getting item from localStorage:', error);
            return defaultValue;
        }
    }

    safeSetItem(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (error) {
            console.error('Error setting item to localStorage:', error);
        }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    notifyDataChange() {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        if (typeof window !== 'undefined') {
            window.dispatchEvent(new CustomEvent('dataChanged', {
                detail: { timestamp: Date.now() }
            }));
        }
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    getUsers() {
        return this.users;
    }

    getUserById(id) {
        return this.users.find(user => user.id === id);
    }

    addUser(user) {
        user.id = Date.now().toString();
        user.createdAt = new Date().toISOString();
        user.status = 'active';
        this.users.push(user);
        this.saveData();
        return user;
    }

    updateUser(id, updates) {
        const userIndex = this.users.findIndex(user => user.id === id);
        if (userIndex !== -1) {
            this.users[userIndex] = { ...this.users[userIndex], ...updates };
            this.saveData();
            return true;
        }
        return false;
    }

    deleteUser(id) {
        const userIndex = this.users.findIndex(user => user.id === id);
        if (userIndex !== -1) {
            this.users.splice(userIndex, 1);
            this.saveData();
            return true;
        }
        return false;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–≥—Ä–∞–º–∏
    getGames() {
        return this.games;
    }

    getGameById(id) {
        return this.games.find(game => game.id === id);
    }

    addGame(game) {
        game.id = Date.now().toString();
        game.createdAt = new Date().toISOString();
        this.games.push(game);
        this.saveData();
        return game;
    }

    updateGame(id, updates) {
        const gameIndex = this.games.findIndex(game => game.id === id);
        if (gameIndex !== -1) {
            this.games[gameIndex] = { ...this.games[gameIndex], ...updates };
            this.saveData();
            return true;
        }
        return false;
    }

    deleteGame(id) {
        console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∏–≥—Ä—ã —Å ID:', id);
        console.log('üìã –¢–µ–∫—É—â–∏–µ –∏–≥—Ä—ã:', this.games.map(g => ({ id: g.id, title: g.title })));
        
        const gameIndex = this.games.findIndex(game => game.id === id);
        console.log('üîç –ù–∞–π–¥–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å:', gameIndex);
        
        if (gameIndex !== -1) {
            this.games.splice(gameIndex, 1);
            this.saveData();
            console.log('‚úÖ –ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞, –æ—Å—Ç–∞–ª–æ—Å—å –∏–≥—Ä:', this.games.length);
            return true;
        }
        console.log('‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return false;
    }

    searchGames(query, filter = 'all') {
        if (!query) return this.games;
        
        return this.games.filter(game => 
            game.title.toLowerCase().includes(query.toLowerCase()) ||
            game.description.toLowerCase().includes(query.toLowerCase())
        );
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤–æ—Å—Ç—è–º–∏
    getNews() {
        return this.news;
    }

    getNewsById(id) {
        return this.news.find(news => news.id === id);
    }

    addNews(newsItem) {
        newsItem.id = Date.now().toString();
        newsItem.createdAt = new Date().toISOString();
        newsItem.author = newsItem.author || 'admin';
        this.news.push(newsItem);
        this.saveData();
        return newsItem;
    }

    updateNews(id, updates) {
        const newsIndex = this.news.findIndex(item => item.id === id);
        if (newsIndex !== -1) {
            this.news[newsIndex] = { ...this.news[newsIndex], ...updates };
            this.saveData();
            return true;
        }
        return false;
    }

    deleteNews(id) {
        console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ —Å ID:', id);
        console.log('üìã –¢–µ–∫—É—â–∏–µ –Ω–æ–≤–æ—Å—Ç–∏:', this.news.map(n => ({ id: n.id, title: n.title })));
        
        const newsIndex = this.news.findIndex(news => news.id === id);
        console.log('üîç –ù–∞–π–¥–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å:', newsIndex);
        
        if (newsIndex !== -1) {
            this.news.splice(newsIndex, 1);
            this.saveData();
            console.log('‚úÖ –ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞, –æ—Å—Ç–∞–ª–æ—Å—å –Ω–æ–≤–æ—Å—Ç–µ–π:', this.news.length);
            return true;
        }
        console.log('‚ùå –ù–æ–≤–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return false;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
    getSupportTickets() {
        return this.supportTickets;
    }

    getSupportTicketById(id) {
        return this.supportTickets.find(ticket => ticket.id === id);
    }

    addSupportTicket(ticket) {
        ticket.id = Date.now().toString();
        ticket.createdAt = new Date().toISOString();
        ticket.status = 'open';
        ticket.responses = [];
        this.supportTickets.push(ticket);
        this.saveData();
        return ticket;
    }

    addSupportResponse(ticketId, response) {
        const ticket = this.supportTickets.find(t => t.id === ticketId);
        if (ticket) {
            if (!ticket.responses) ticket.responses = [];
            ticket.responses.push({
                id: Date.now().toString(),
                message: response,
                isAdmin: true,
                createdAt: new Date().toISOString()
            });
            ticket.status = 'resolved';
            this.saveData();
            return true;
        }
        return false;
    }

    updateTicketStatus(ticketId, status) {
        const ticket = this.supportTickets.find(t => t.id === ticketId);
        if (ticket) {
            ticket.status = status;
            this.saveData();
            return true;
        }
        return false;
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    getStats() {
        return {
            totalUsers: this.users.length,
            activeUsers: this.users.filter(u => u.status !== 'blocked').length,
            blockedUsers: this.users.filter(u => u.status === 'blocked').length,
            totalGames: this.games.length,
            totalNews: this.news.length,
            openTickets: this.supportTickets.filter(t => t.status === 'open').length,
            resolvedTickets: this.supportTickets.filter(t => t.status === 'resolved').length
        };
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    initializeTestData() {
        // (–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –±–æ–ª—å—à–µ –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        console.log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (–±–µ–∑ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è)');
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    clearAllData() {
        this.users = [];
        this.games = [];
        this.news = [];
        this.supportTickets = [];
        this.saveData();
        console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
    }
} 